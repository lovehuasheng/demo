var pagesize = 5;//全局变量，每页显示多少条
var k = $('.hhs_input_k').val();
var stock_num = parseInt($('.hhs_input_num').val());
var flag = false;
var no_num = 0;
var hhs_suplier_num = parseInt($('#hhs_suplier_num').text())-1+1+1;//加一是走本地数据/临时数据
var suplier_num = 0;
var stra_msg = eval('(' + $('#hhs_stra_msg').text() + ')');

$(function(){
    //初始化
    start_search();
    //点击触发

    function start_search(){
        search.init();
        search.searchlist();

        var kk = $('.hhs_input_k').val();
        start(kk);
    }

//    $(window).load(function() {
//        findGoods();
//    });
})

function start(kk){
    var ids = $('#fuck').text();
    var obj = eval('(' + ids + ')');
    $.each(obj,function(i){
        get_data(i,kk);
    });
}

//循环获取数据
function get_data(i,kk){
    $.ajax({
        url: 'http://szso.ichunt.com/search/?k='+i+'&keyword='+encodeURIComponent(kk)+'&kNums='+stock_num+'&callback=?',
        //url: 'http://szso.ichunt.com/search/?k='+i+'&keyword='+encodeURIComponent(kk)+'&kNums='+stock_num+'&callback=?',
        dataType: 'jsonp',
        success: function(res){
            show_data(res,i);
        },
        error:function(xhr){
            //alert('网络错误');
        }
    });
}
//数据解析中转、分撮合、联营
function show_data(res,m){
    if(m == 16){
        cuohe(res,m);
    }else{
        term(res,m);
    }

}
//撮合数据拼接展示
function cuohe(res,m){
    if(res.status == 0){
        var idclass = 'hhs_block'+m;
        var html = '<div class="list_block '+idclass+'">';
        var goods_name_list = '';
        $.each(res.PD,function(i){
            var data = res.PD;
            goods_name_list += '<li>'+data[i].goods_name+'</li>';
            html += '<ul class="clear">'+
            '<li class="w-110">'+
            '<p class="hhs_goods_name f-gray">'+data[i].goods_name_temp+'</p>'+
            '</li>'+
            '<li class="w-130">'+data[i].company_name+'</li>'+
            '<li class="w-160">'+data[i].provider_name+'</li>'+
            '<li class="w-90">'+
            '<p><span class="f-gray">批次：</span>'+'--'+'</p>'+
            '</li>'+
            '<li class="w-90">'+
            '<p><span class="f-gray">库存：</span><span class="f-red">'+data[i].goods_number+'</span></p>'+
            '</li>'+
            '<li class="w-260 morePrice">'+
            '<div class="list_data">'+
            '<p class="w-50 f-red">'+'--'+'</p>'+
            '<p class="w-50 f-red">'+'--'+'</p>'+
            '</div>'+
            '</li>'+
            '<li class="w-130">'+
            '<p>香港：'+'--'+'</p>'+
            '<p>国内：'+'--'+'</p>'+
            '</li>'+
            '<li class="w-126 edit-but">'+
            '<a href="http://wpa.b.qq.com/cgi/wpa.php?ln=2&uin=800158432&o=www.ichunt.com&q=7&ref=http://www.ichunt.com/" class="but but-orange" target="_blank">立即询价</a>'+
            '</li>'+
            '</ul>';
            //alert(JSON.stringify(res[i].data[n]));
        })
        var n = res.PD.length-2;
        if(n>0){
            html += '<div class="more-number">还有<span class="f-blue">'+n+'</span>个商品未显示，<span class="hhs_load_more cup" less_val="'+n+'" len_val="'+res.PD.length+'">点击加载更多<i></i></span></div></div>';
        }else{
            //html += '<div class="more-number">为您找到<span class="f-blue">'+res.PD.length+'</span>个商品，已全部显示</div></div>';
        }
        html += '</div>';
        $('.cuohelist').html(html);
        select(goods_name_list);
        show_less(idclass);
    }else{
        search.nocontent($('.cuohelist'));
    }

}
//临时数据、联营数据拼接展示
function jjj(res,m){

    suplier_num = suplier_num + 1;
    if(res.length>0){
        flag = true;
        var goods_name_list = '';
        $.each(res,function(i){
            var idclass = 'hhs_block'+m;
            if(m == 11){
                idclass += i;
            }else if(m == 'fuck'){
                idclass += i;
            }
            var html = '<div class="hhs_list list_block '+idclass+'">';
            if(m != 'fuck'){
                html +='<div class="name-shop"><img src="'+res[i].PIUrl+'" class="name-img"></div>';
            }

            var tatol = res[i].data.length;
            $.each(res[i].data,function(n){
                var data = res[i].data[n];
                if(data.tiered.length>0){
                    var start_num = data.tiered[0][0];
                }
                var start_money = 0;
                goods_name_list += '<li>'+data.goods_name+'</li>';
                html += '<ul class="clear hhs_goods">'+
                '<li class="w-110">'+
                '<p class="hhs_goods_name"><a href="'+URL_DOMAIN+'/goods_'+data.goods_id+'.html'+'" target="_blank" class="fw">'+data.goods_name_temp+'</a></p>'+
                '</li>'+
                '<li class="w-130">';
//                    if(m == 'fuck'){
//                        html += '<div class="name-text">猎芯联营';
//                    }else{
                html += '<div class="name-text">'+res[i].com_name;
//                    }

                if(res[i].com_id && stra_msg[res[i].com_id]){
                    html += '<div class="hint"><div class="arrow"><span></span><i></i></div><p>'+stra_msg[res[i].com_id]+'</p></div>';
                }
                html += '</div>'+

                '</li>'+
                '<li class="w-160">'+data.brand_name+'</li>'+
                '<li class="w-90">'+
                '<p><span class="f-gray">批次：</span>--</p>'+
                '<p><span class="f-gray">编号：</span>--</p>'+
                '</li>'+
                '<li class="w-90">'+
                '<p><span class="f-gray">库存：</span><span class="f-red">'+(data.stock[1]?data.stock[1]:'--')+'</span></p>'+
                '<p><span class="f-gray">起订：</span>'+(data.stock[0]?data.stock[0]:'--')+'</p>'+
                '<p><span class="f-gray" title="标准包装量">MPQ：</span>'+data.increment+'</p>'+
                '</li>'+
                '<li class="w-260 morePrice">';
                var len = data.tiered.length;
                var price_dollor = '{';
                var price_rmb = '{';
                var flag = 0;
                var price_temp = 0;
                var last_price = 0;
                var hhs_stock = 0;
                var hhs_last_stock = 0;
                var p_price;
                if(len>0){
                    if(data.tiered[0][3]>0 || data.tiered[0][2]>0){
                        for(var tt=0;tt<len;tt++){
                            if(data.tiered[tt][0] == data.stock[0]){
                                hhs_stock = data.tiered[tt][0];
                                if(data.tiered[tt][2]>0){
                                    price_temp = data.tiered[tt][2];break;
                                }else{
                                    price_temp = data.tiered[tt][3];break;
                                }
                            }else if(data.tiered[tt][0] > data.stock[0]){
                                hhs_stock = hhs_last_stock;
                                price_temp = last_price;break;
                            }
                            hhs_last_stock = data.tiered[tt][0];
                            if(data.tiered[tt][2]>0){
                                last_price = data.tiered[tt][2];
                            }else{
                                last_price = data.tiered[tt][3];
                            }
                        }
                        if(price_temp == 0){
                            if(last_price>0){
                                price_temp = last_price;
                                hhs_stock = hhs_last_stock;
                            }else{
                                hhs_stock = data.tiered[0][0];
                                if(data.tiered[0][2]>0){
                                    price_temp = data.tiered[0][2];
                                }else{
                                    price_temp = data.tiered[0][3];
                                }
                            }

                        }
                        if(data.tiered[0][3]<=0 && data.tiered[0][2]>0){
                            flag = 1;
                            p_price = price_temp*data.stock[0];
                            start_money = '￥'+p_price.toFixed(4);
                        }else if(data.tiered[0][2]<=0 && data.tiered[0][3]>0){
                            flag = 2;
                            p_price = price_temp*data.stock[0];
                            start_money = '$'+p_price.toFixed(4);
                        }else{
                            flag = 4;
                            p_price = price_temp*data.stock[0];
                            start_money = '￥'+p_price.toFixed(4);
                        }
                        for(var tt=0;tt<len;tt++){
                            if(data.stock[1]<data.stock[0] || m=='fuck'){
                                html += '<div class="list_data">'+
                                '<p class="w-20">'+data.tiered[tt][0]+'</p>'+
//                                            '<p class="w-40"><span class="'+((data.tiered[tt][2]==price_temp && flag!=2) ? '':'')+'">'+(data.tiered[tt][2]>0 ? '￥'+data.tiered[tt][2]:'--')+'</span></p>'+
//                                            '<p class="w-40"><span class="'+((data.tiered[tt][3]==price_temp && flag==2) ? '':'')+'">'+(data.tiered[tt][3]>0 ? '$'+data.tiered[tt][3]:'--')+'</span></p>'+
                                '<p class="w-40"><span class="'+((data.tiered[tt][0]==hhs_stock && flag!=2) ? '':'')+'">'+(data.tiered[tt][2]>0 ? '￥'+data.tiered[tt][2]:'--')+'</span></p>'+
                                '<p class="w-40"><span class="'+((data.tiered[tt][0]==hhs_stock && flag==2) ? '':'')+'">'+(data.tiered[tt][3]>0 ? '$'+data.tiered[tt][3]:'--')+'</span></p>'+
                                '</div>';
                            }else{
                                html += '<div class="list_data">'+
                                '<p class="w-20">'+data.tiered[tt][0]+'</p>'+
//                                            '<p class="w-40"><span class="'+((data.tiered[tt][2]==price_temp && flag!=2) ? 'act':'')+'">'+(data.tiered[tt][2]>0 ? '￥'+data.tiered[tt][2]:'--')+'</span></p>'+
//                                            '<p class="w-40"><span class="'+((data.tiered[tt][3]==price_temp && flag==2) ? 'act':'')+'">'+(data.tiered[tt][3]>0 ? '$'+data.tiered[tt][3]:'--')+'</span></p>'+
                                '<p class="w-40"><span class="'+((data.tiered[tt][0]==hhs_stock && flag!=2) ? 'act':'')+'">'+(data.tiered[tt][2]>0 ? '￥'+data.tiered[tt][2]:'--')+'</span></p>'+
                                '<p class="w-40"><span class="'+((data.tiered[tt][0]==hhs_stock && flag==2) ? 'act':'')+'">'+(data.tiered[tt][3]>0 ? '$'+data.tiered[tt][3]:'--')+'</span></p>'+
                                '</div>';
                            }

                            price_rmb += (data.tiered[tt][0]+':"'+data.tiered[tt][2]+'",');
                            price_dollor += (data.tiered[tt][0]+':"'+data.tiered[tt][3]+'",');
                        };
                    }else{
                        flag = 3;
                        html +='<div class="list_data">'
                        +'<p class="w-20"><span>--</span></p>'
                        +'<p class="w-40"><span class="">--</span></p>'
                        +'<p class="w-40"><span>--</span></p>'
                        +'</div>';
                    }

                }else{
                    flag = 3;
                    html +='<div class="list_data">'
                    +'<p class="w-20"><span>--</span></p>'
                    +'<p class="w-40"><span class="">--</span></p>'
                    +'<p class="w-40"><span>--</span></p>'
                    +'</div>';
                }
                var priceobj = '';
                var pricermb = '';
                if(len>0){
                    var nn = price_dollor.length-1;
                    var mm = price_rmb.length-1;
                    priceobj = (price_dollor.substr(0,nn))+'}';
                    pricermb = (price_rmb.substr(0,mm))+'}';
                }

                html += '<div class="more-height"><span class="icon-bot">更多梯度价格<i></i></span></div>'+
                '</li>'+
                '<li class="w-130">'+
                '<div class="time-cont"><input type="hidden" name="money_type" value="'+(flag!=2 ? 1:0)+'"/>';
                if(data.stock[1]>=data.stock[0] && res[i].DT.length>0){
                    if(flag == 2){
                        html += '<p><label>'+
                        '<span class="check-img"><i class="icon-check act-radio"></i><input type="radio" start_num_val="'+(data.stock[0]?data.stock[0]:1)+'" name="currency'+data.goods_id+'" value="0"></span>'+
                        ''+(res[i].DT[0] ? res[i].DT[0]:'--')+
                        '</label></p>';
                        html +=  '</div><a href="javascript:void(0)" id_val="'+data.goods_id+'" name_val="'+data.goods_name+'" source_val="2" class="but but-white hhs_bug">立即购买</a>';
                    }else if(flag == 1){
                        html += '<p><label>'+
                        '<span class="check-img"><i class="icon-check act-radio"></i><input type="radio" start_num_val="'+(data.stock[0]?data.stock[0]:1)+'" name="currency'+data.goods_id+'" value="1"></span>'+
                        ''+(res[i].DT[1] ? res[i].DT[1]:'--')+
                        '</label></p>';
                        html +=  '</div><a href="javascript:void(0)" id_val="'+data.goods_id+'" name_val="'+data.goods_name+'" source_val="2" class="but but-white hhs_bug">立即购买</a>';
                    }else if(flag == 4){
                        html += '<p><label>'+
                        '<span class="check-img"><i class="icon-check"></i><input type="radio" start_num_val="'+(data.stock[0]?data.stock[0]:1)+'" name="currency'+data.goods_id+'" value="0"></span>'+
                        ''+(res[i].DT[0] ? res[i].DT[0]:'--')+
                        '</label></p>'+
                        '<p><label>'+
                        '<span class="check-img"><i class="icon-check act-radio"></i><input type="radio" start_num_val="'+(data.stock[0]?data.stock[0]:1)+'" name="currency'+data.goods_id+'" value="1"></span>'+
                        ''+(res[i].DT[1] ? res[i].DT[1]:'--')+
                        '</label></p>';
                        html +=  '</div><a href="javascript:void(0)" id_val="'+data.goods_id+'" name_val="'+data.goods_name+'" source_val="2" class="but but-white hhs_bug">立即购买</a>';
                    }else{
                        html += '<label>--</label></div>';
                    }
                }else{
                    html += '<label>--</label></div>';
                }



                html += '</li>'+
                '<li class="w-126 edit-but">';
                if(flag == 3 || data.stock[1]<data.stock[0] || res[i].DT.length<=0){
                    html += '<a href="'+URL_DOMAIN+'/goods_'+data.goods_id+'.html'+'" id_val="'+data.goods_id+'" name_val="'+data.goods_name+'" source_val="2" class="but popup-but">加入购物车</a>';
                    //html += '<a href="http://wpa.b.qq.com/cgi/wpa.php?ln=2&uin=800158432&o=www.ichunt.com&q=7&ref=http://www.ichunt.com/" target="_blank" class="but but-orange">立即询价</a>';
                }else{
                    html += '<div class="edit-input clear">'+
                    '<div class="warn-hint ta-c hhs_tishi1"><i class="arrow"></i><i class="icon-warn"></i><p>购买数量不能少于起订量！</p></div>'+
                    '<div class="warn-hint hhs_tishi2"><i class="arrow"></i><i class="icon-warn fl-l"></i><p class="fl-l">购买数量不能超过库存量，若要采购更多，请联系在线客服！</p></div>'+
                    '<span class="reduce" stock_val="'+(data.stock[1]?data.stock[1]:'--')+'" start_val="'+(data.stock[0]?data.stock[0]:1)+'" " cre_val='+data.increment+' doll_val='+priceobj+' rmb_val='+pricermb+'>-</span>'+
                    '<input type="text" name="order_num" value="'+(data.stock[0]?data.stock[0]:1)+'">'+
                    '<span class="increase" stock_val="'+(data.stock[1]?data.stock[1]:'--')+'" start_val="'+(data.stock[0]?data.stock[0]:1)+'" cre_val='+data.increment+' doll_val='+priceobj+' rmb_val='+pricermb+'>+</span>'+
                    '</div>'+
                    '<p class="f-red">合计：<b class="addCart-currency">'+(start_money ? start_money :1)+'</b></p>'+
                    '<a href="javascript:void(0)" id_val="'+data.goods_id+'" name_val="'+data.goods_name+'" source_val="2" class="but popup-but hhs_cart">加入购物车</a>';
                }

                html += '</li></ul>';
            });
            var n = res[i].data.length-2;
            if(n>0){
                html += '<div class="more-number">还有<span class="f-blue">'+n+'</span>个商品未显示，<span class="hhs_load_more cup" less_val="'+n+'" len_val="'+tatol+'">点击加载更多<i></i></span></div></div>';
            }else{
                //html += '<div class="more-number">为您找到<span class="f-blue">'+res[i].data.length+'</span>个商品，已全部显示</div></div>';
            }

            $('.lianyinlist').append(html);
            show_less(idclass);
        });
        select(goods_name_list);
        search.showCartMorePrice();
        radis_check();
        search.sumMoney();
        search.orderNum();//计算直接数入数量
    }
    //alert(suplier_num);alert(hhs_suplier_num);
    if(suplier_num == hhs_suplier_num && !flag){
        search.nocontent($('.lianyinlist'));
    }

}
//联营数据拼接展示
function term(res,m){

    suplier_num = suplier_num + 1;
    if(res.length>0){
        flag = true;
        var goods_name_list = '';
        $.each(res,function(i){
            var idclass = 'hhs_block'+m;
            if(m == 11){
                idclass += i;
            }else if(m == 'fuck'){
                idclass += i;
            }
            var html = '<div class="hhs_list list_block '+idclass+'">';
            if(m != 'fuck'){
                html +='<div class="name-shop"><img src="'+res[i].PIUrl+'" class="name-img"></div>';
            }

            var tatol = res[i].data.length;
            $.each(res[i].data,function(n){
                var data = res[i].data[n];
                if(data.tiered.length>0){
                    var start_num = data.tiered[0][0];
                }
                var start_money = 0;
                goods_name_list += '<li>'+data.goods_name+'</li>';
                html += '<ul class="clear hhs_goods">'+
                '<li class="w-110">'+
                '<p class="hhs_goods_name"><a href="'+URL_DOMAIN+'/goods_'+data.goods_id+'.html'+'" target="_blank" class="fw">'+data.goods_name_temp+'</a></p>'+
                '</li>'+
                '<li class="w-130">';
//                    if(m == 'fuck'){
//                        html += '<div class="name-text">猎芯联营';
//                    }else{
                html += '<div class="name-text">'+res[i].com_name;
//                    }

                if(res[i].com_id && stra_msg[res[i].com_id]){
                    html += '<div class="hint"><div class="arrow"><span></span><i></i></div><p>'+stra_msg[res[i].com_id]+'</p></div>';
                }
                html += '</div>'+

                '</li>'+
                '<li class="w-160">'+data.brand_name+'</li>'+
                '<li class="w-90">'+
                '<p><span class="f-gray">批次：</span>--</p>'+
                '<p><span class="f-gray">编号：</span>--</p>'+
                '</li>'+
                '<li class="w-90">'+
                '<p><span class="f-gray">库存：</span><span class="f-red">'+(data.stock[1]?data.stock[1]:'--')+'</span></p>'+
                '<p><span class="f-gray">起订：</span>'+(data.stock[0]?data.stock[0]:'--')+'</p>'+
                '<p><span class="f-gray" title="标准包装量">MPQ：</span>'+data.increment+'</p>'+
                '</li>'+
                '<li class="w-260 morePrice">';
                var len = data.tiered.length;
                var price_dollor = '{';
                var price_rmb = '{';
                var flag = 0;
                var price_temp = 0;
                var last_price = 0;
                var hhs_stock = 0;
                var hhs_last_stock = 0;
                var p_price;
                var stock_temp = data.stock[0];
                stock_num = parseInt(stock_num);
                var yu = stock_num%(data.increment);
                //如果用户有输入库存作为搜索条件，则合计与初始数量以库存量为准
                if(stock_num>0 && stock_num>=data.stock[0] && yu===0){
                    data.stock[0] = stock_num;
                }
                
                if(len>0){
                    if(data.tiered[0][3]>0 || data.tiered[0][2]>0){
                        for(var tt=0;tt<len;tt++){
                            if(data.tiered[tt][0] == data.stock[0]){
                                hhs_stock = data.tiered[tt][0];
                                if(data.tiered[tt][2]>0){
                                    price_temp = data.tiered[tt][2];break;
                                }else{
                                    price_temp = data.tiered[tt][3];break;
                                }
                            }else if(data.tiered[tt][0] > data.stock[0]){
                                hhs_stock = hhs_last_stock;
                                price_temp = last_price;break;
                            }
                            hhs_last_stock = data.tiered[tt][0];
                            if(data.tiered[tt][2]>0){
                                last_price = data.tiered[tt][2];
                            }else{
                                last_price = data.tiered[tt][3];
                            }
                        }
                        if(price_temp == 0){
                            if(last_price>0){
                                price_temp = last_price;
                                hhs_stock = hhs_last_stock;
                            }else{
                                hhs_stock = data.tiered[0][0];
                                if(data.tiered[0][2]>0){
                                    price_temp = data.tiered[0][2];
                                }else{
                                    price_temp = data.tiered[0][3];
                                }
                            }

                        }
                        if(data.tiered[0][3]<=0 && data.tiered[0][2]>0){
                            flag = 1;
                            p_price = price_temp*data.stock[0];
                            start_money = '￥'+p_price.toFixed(4);
                        }else if(data.tiered[0][2]<=0 && data.tiered[0][3]>0){
                            flag = 2;
                            p_price = price_temp*data.stock[0];
                            start_money = '$'+p_price.toFixed(4);
                        }else{
                            flag = 4;
                            p_price = price_temp*data.stock[0];
                            start_money = '￥'+p_price.toFixed(4);
                        }
                        for(var tt=0;tt<len;tt++){
                            if(data.stock[1]<data.stock[0] || m=='fuck'){
                                html += '<div class="list_data">'+
                                '<p class="w-20">'+data.tiered[tt][0]+'</p>'+
//                                            '<p class="w-40"><span class="'+((data.tiered[tt][2]==price_temp && flag!=2) ? '':'')+'">'+(data.tiered[tt][2]>0 ? '￥'+data.tiered[tt][2]:'--')+'</span></p>'+
//                                            '<p class="w-40"><span class="'+((data.tiered[tt][3]==price_temp && flag==2) ? '':'')+'">'+(data.tiered[tt][3]>0 ? '$'+data.tiered[tt][3]:'--')+'</span></p>'+
                                '<p class="w-40"><span class="'+((data.tiered[tt][0]==hhs_stock && flag!=2) ? '':'')+'">'+(data.tiered[tt][2]>0 ? '￥'+data.tiered[tt][2]:'--')+'</span></p>'+
                                '<p class="w-40"><span class="'+((data.tiered[tt][0]==hhs_stock && flag==2) ? '':'')+'">'+(data.tiered[tt][3]>0 ? '$'+data.tiered[tt][3]:'--')+'</span></p>'+
                                '</div>';
                            }else{
                                html += '<div class="list_data">'+
                                '<p class="w-20">'+data.tiered[tt][0]+'</p>'+
//                                            '<p class="w-40"><span class="'+((data.tiered[tt][2]==price_temp && flag!=2) ? 'act':'')+'">'+(data.tiered[tt][2]>0 ? '￥'+data.tiered[tt][2]:'--')+'</span></p>'+
//                                            '<p class="w-40"><span class="'+((data.tiered[tt][3]==price_temp && flag==2) ? 'act':'')+'">'+(data.tiered[tt][3]>0 ? '$'+data.tiered[tt][3]:'--')+'</span></p>'+
                                '<p class="w-40"><span class="'+((data.tiered[tt][0]==hhs_stock && flag!=2) ? 'act':'')+'">'+(data.tiered[tt][2]>0 ? '￥'+data.tiered[tt][2]:'--')+'</span></p>'+
                                '<p class="w-40"><span class="'+((data.tiered[tt][0]==hhs_stock && flag==2) ? 'act':'')+'">'+(data.tiered[tt][3]>0 ? '$'+data.tiered[tt][3]:'--')+'</span></p>'+
                                '</div>';
                            }

                            price_rmb += (data.tiered[tt][0]+':"'+data.tiered[tt][2]+'",');
                            price_dollor += (data.tiered[tt][0]+':"'+data.tiered[tt][3]+'",');
                        };
                    }else{
                        flag = 3;
                        html +='<div class="list_data">'
                        +'<p class="w-20"><span>--</span></p>'
                        +'<p class="w-40"><span class="">--</span></p>'
                        +'<p class="w-40"><span>--</span></p>'
                        +'</div>';
                    }

                }else{
                    flag = 3;
                    html +='<div class="list_data">'
                    +'<p class="w-20"><span>--</span></p>'
                    +'<p class="w-40"><span class="">--</span></p>'
                    +'<p class="w-40"><span>--</span></p>'
                    +'</div>';
                }
                var priceobj = '';
                var pricermb = '';
                if(len>0){
                    var nn = price_dollor.length-1;
                    var mm = price_rmb.length-1;
                    priceobj = (price_dollor.substr(0,nn))+'}';
                    pricermb = (price_rmb.substr(0,mm))+'}';
                }

                html += '<div class="more-height"><span class="icon-bot">更多梯度价格<i></i></span></div>'+
                '</li>'+
                '<li class="w-130">'+
                '<div class="time-cont"><input type="hidden" name="money_type" value="'+(flag!=2 ? 1:0)+'"/>';
                //切换回来
                data.stock[0] = stock_temp;

                if(data.stock[1]>=data.stock[0] && res[i].DT.length>0 && (parseInt(data.stock[1])>=parseInt(data.increment))){
                    if(flag == 2){
                        html += '<p><label>'+
                        '<span class="check-img"><i class="icon-check act-radio"></i><input type="radio" start_num_val="'+(data.stock[0]?data.stock[0]:1)+'" name="currency'+data.goods_id+'" value="0"></span>'+
                        ''+(res[i].DT[0] ? res[i].DT[0]:'--')+
                        '</label></p>';
                        html +=  '</div><a href="javascript:void(0)" id_val="'+data.goods_id+'" name_val="'+data.goods_name+'" source_val="2" class="but but-white hhs_bug">立即购买</a>';
                    }else if(flag == 1){
                        html += '<p><label>'+
                        '<span class="check-img"><i class="icon-check act-radio"></i><input type="radio" start_num_val="'+(data.stock[0]?data.stock[0]:1)+'" name="currency'+data.goods_id+'" value="1"></span>'+
                        ''+(res[i].DT[1] ? res[i].DT[1]:'--')+
                        '</label></p>';
                        html +=  '</div><a href="javascript:void(0)" id_val="'+data.goods_id+'" name_val="'+data.goods_name+'" source_val="2" class="but but-white hhs_bug">立即购买</a>';
                    }else if(flag == 4){
                        html += '<p><label>'+
                        '<span class="check-img"><i class="icon-check"></i><input type="radio" start_num_val="'+(data.stock[0]?data.stock[0]:1)+'" name="currency'+data.goods_id+'" value="0"></span>'+
                        ''+(res[i].DT[0] ? res[i].DT[0]:'--')+
                        '</label></p>'+
                        '<p><label>'+
                        '<span class="check-img"><i class="icon-check act-radio"></i><input type="radio" start_num_val="'+(data.stock[0]?data.stock[0]:1)+'" name="currency'+data.goods_id+'" value="1"></span>'+
                        ''+(res[i].DT[1] ? res[i].DT[1]:'--')+
                        '</label></p>';
                        html +=  '</div><a href="javascript:void(0)" id_val="'+data.goods_id+'" name_val="'+data.goods_name+'" source_val="2" class="but but-white hhs_bug">立即购买</a>';
                    }else{
                        html += '<label>--</label></div>';
                    }
                }else{
                    html += '<label>--</label></div>';
                }


                //切换回来
                var temp_order_num;
                if(stock_num<=data.stock[0] || yu!=0){
                    temp_order_num = data.stock[0];
                }else{
                    temp_order_num = stock_num;
                }
                html += '</li>'+
                '<li class="w-126 edit-but">';
                if(flag == 3 || data.stock[1]<data.stock[0] || res[i].DT.length<=0 || (parseInt(data.stock[1])<parseInt(data.increment))){
                    html += '<a href="http://wpa.b.qq.com/cgi/wpa.php?ln=2&uin=800158432&o=www.ichunt.com&q=7&ref=http://www.ichunt.com/" target="_blank" class="but but-orange">立即询价</a>';
                }else{
                    html += '<div class="edit-input clear">'+
                    '<div class="warn-hint ta-c hhs_tishi1"><i class="arrow"></i><i class="icon-warn"></i><p>购买数量不能少于起订量！</p></div>'+
                    '<div class="warn-hint hhs_tishi2"><i class="arrow"></i><i class="icon-warn fl-l"></i><p class="fl-l">购买数量不能超过库存量，若要采购更多，请联系在线客服！</p></div>'+
                    '<span class="reduce" stock_val="'+(data.stock[1]?data.stock[1]:'--')+'" start_val="'+(data.stock[0]?data.stock[0]:1)+'" " cre_val='+data.increment+' doll_val='+priceobj+' rmb_val='+pricermb+'>-</span>'+
                    '<input type="text" name="order_num" value="'+(temp_order_num?temp_order_num:1)+'">'+
                    '<span class="increase" stock_val="'+(data.stock[1]?data.stock[1]:'--')+'" start_val="'+(data.stock[0]?data.stock[0]:1)+'" cre_val='+data.increment+' doll_val='+priceobj+' rmb_val='+pricermb+'>+</span>'+
                    '</div>'+
                    '<p class="f-red">合计：<b class="addCart-currency">'+(start_money ? start_money :1)+'</b></p>'+
                    '<a href="javascript:void(0)" id_val="'+data.goods_id+'" name_val="'+data.goods_name+'" source_val="2" class="but popup-but hhs_cart">加入购物车</a>';
                }

                html += '</li></ul>';
            });
            var n = res[i].data.length-2;
            if(n>0){
                html += '<div class="more-number">还有<span class="f-blue">'+n+'</span>个商品未显示，<span class="hhs_load_more cup" less_val="'+n+'" len_val="'+tatol+'">点击加载更多<i></i></span></div></div>';
            }else{
                //html += '<div class="more-number">为您找到<span class="f-blue">'+res[i].data.length+'</span>个商品，已全部显示</div></div>';
            }

            $('.lianyinlist').append(html);
            show_less(idclass);
        });
        select(goods_name_list);
        search.showCartMorePrice();
        radis_check();
        search.sumMoney();
        search.orderNum();//计算直接数入数量
    }
    //alert(suplier_num);alert(hhs_suplier_num);
    if(suplier_num == hhs_suplier_num && !flag){
        search.nocontent($('.lianyinlist'));
    }

}

//显示指定条数
function show_less(idclass){
    $('.'+idclass+'> .clear:gt(1)').hide();

    $('.'+idclass+'> .more-number> .hhs_load_more').on('click',function(){
        var less_val = $(this).attr('less_val');
        var len_val = $(this).attr('len_val');
        var start = len_val-less_val;
        if(less_val>pagesize){
            start += pagesize;
            $('.'+idclass+'> .clear:lt('+start+')').show();
            less_val = less_val-pagesize;
            $(this).attr('less_val',less_val);
            $(this).prev().text(less_val);
        }else{
            start -= 1;
            $('.'+idclass+'> .clear:gt('+start+')').show();
            $(this).parent().html('为您找到<span class="f-blue">'+len_val+'</span>个商品，已全部显示');
        }

    });
}

//选框
function check(el,cl){
    el.parents('.hhs_goods').find('.'+cl).removeClass(cl);
    el.prev('.icon-check').addClass(cl);
}
//点击货币类型
function radis_check(){
    $('input[type="radio"]').unbind('click');
    $('input[type="radio"]').on('click',function(){
        var tt = $(this).parents('.hhs_goods');
        var obj = tt.find('.act');
        var num = tt.find('input[name="order_num"]').val();
        if($(this).val() == 1){
            if($(this).parents('.time-cont').children('input[name="money_type"]').val() == 1){
                return false;
            }
            obj.parent().prev().children('span').addClass('act');
            obj.removeClass('act');
            var money = (obj.parent().prev().children('span').text()).substr(1);
            var first_let = (obj.parent().prev().children('span').text()).substr(0,1);
            var ttemp = money*num;
            tt.find('.addCart-currency').text(first_let+ttemp.toFixed(4));
            $(this).parents('.time-cont').children('input[name="money_type"]').val('1');
        } else {
            if($(this).parents('.time-cont').children('input[name="money_type"]').val() == 0){
                return false;
            }
            obj.parent().next().children('span').addClass('act');
            obj.removeClass('act');
            var money = (obj.parent().next().children('span').text()).substr(1);
            var first_let = (obj.parent().next().children('span').text()).substr(0,1);
            var ttemp = money*num;
            tt.find('.addCart-currency').text(first_let+ttemp.toFixed(4));
            $(this).parents('.time-cont').children('input[name="money_type"]').val('0');
        }

        check($(this),'act-radio');
    })
}
//加载商品名下拉表
function select(html){
    $.each($('.selectbox-cont'),function(i){
        $(this).append(html);
        findGoods();
    });
}
//精确搜索
function findGoods(){
    $('#goods_temp> li').unbind('click');
    $('#goods_temp> li').on('click',function(){
        var goods_name = $(this).text();
        var flag = false;
        if(goods_name == '全部'){
            goods_name = $('.hhs_input_k').val();
            flag = true;
        }
        zhuanmaiGoods(goods_name,flag);
        lianCuoGoods(goods_name);
    })
}
//专卖精确搜索
function zhuanmaiGoods(goods_name,flag){
    var com_ids = $('#hhs_all_com_ids').text();
    $.ajax({
        type: "POST",
        url: URL_PRFIX+"api?mod=Search&act=FindGoods",
        data:{"com_ids" : com_ids, "kNums" : 0,"k" : goods_name,"flag":flag},
        dataType: "json",
        xhrFields: {withCredentials: true},
        success: function(model){
            //console.log(model);
            if(model.err_code==0){
                var resp = model.data;
                var res = resp.data;
                var shoplist='';
                $.each(resp.data, function(i){
                    var listblock = '<div class="list-block">';
                    listblock +='<div class="block-ul">'+search.block(model,i)+'</div>';
                    // listblock +=search.morenumber();
                    if (res[i].data_list.length < res[i].total_num) {
                        var jian=res[i].total_num-res[i].data_list.length;
                        var more_number = '<div class="more-number">还有'
                            +'<span class="f-blue">'+jian+'</span>'
                            +'个商品未显示，<a href="javascript:void(0);" class="f-blue hhs_morenumber" onclick="" tatol_val="'+res[i].total_num+'" com_val="'+res[i].suplier_ids+'">点击加载更多<i></i></a></div>';
                        listblock +=more_number+'</div>';
                    }else{
                        // var more_number2 = '<div class="more-number">为您找到'
                        //      +'<span class="f-blue">'+res[i].total_num+'</span>'
                        //      +'个商品，已全部显示</div>';
                        //  listblock +=more_number2+'</div>';
                    }

                    listblock +='</div>';
                    shoplist += listblock;
                });
                // shoplist += '<span id="hhs_all_com_ids" style="display:none">'+resp.all_com_ids+'</span>';
                $('#shoplist').html(shoplist);

                search.morenumber();
                search.showCartMorePrice();
                search.sumMoney();
                radis_check();
                search.orderNum();//计算直接数入数量

            }else{
                $('#shoplist').html('');
                search.nocontent($('#shoplist'));
            }
        }
    });
}
//联营撮合精确搜索
function lianCuoGoods(goods_name){
    $('.lianyin .list').html('');
    $('.cuohe .list').html('');
    start(goods_name);
//        var obj = $('.hhs_list');
//        $.each(obj,function(i){
//            var name_obj = $(this).find('.hhs_goods_name');
//            $.each(name_obj,function(n){
//                if(goods_name == $(this).text()){
//                    //$(this).parent('.hhs_goods').show();
//                }else{
//
//                }
//            })
//        })
}
var search={

    init:function(){

        //经营类型
        $(".sift-ul li").click(function(){
            $(this).addClass("sift-act").siblings().removeClass("sift-act");
            if ($('.sift-ul .zhuanmai_a').is(".sift-act")) {
                //alert(1);
                $('.search-product .zhuanmai').show().siblings('.block').hide();
            }else if ($('.sift-ul .lianyin_a').is(".sift-act")) {
                $('.search-product .lianyin').show().siblings('.block').hide();
            }else if ($('.sift-ul .cuohe_a').is(".sift-act")) {
                $('.search-product .cuohe').show().siblings('.block').hide();
            }else{
                var nn = parseInt($('.zhuanmai').find('.no_content').length);
                if(nn == 0){
                    $('.zhuanmai').show();
                }else{
                    $('.zhuanmai').hide();
                }
                nn = parseInt($('.lianyin').find('.no_content').length);
                if(nn == 0){
                    $('.lianyin').show();
                }else{
                    $('.lianyin').hide();
                }
                nn = parseInt($('.cuohe').find('.no_content').length);
                if(nn == 0){
                    $('.cuohe').show();
                }else{
                    $('.cuohe').hide();
                }

            }
        });
        //搜索-浮层-1
        if($("#layout-search-top").length > 0){
            var searchHeight= $("#layout-search-top").offset().top;
            var searchfix=$("#layout-search-top").children(".layout-search");
            $(window).scroll(function(){
                if($(this).scrollTop()>searchHeight){
                    searchfix.addClass("search-fix");
                }else{
                    searchfix.removeClass("search-fix");
                }
            })
        }

    },
    //专卖商城
    searchlist:function(){
        k = $('.hhs_input_k').val();
        $.ajax({
            type: "GET",
            url: URL_PRFIX+"api?mod=Search&act=index",
            data:{"k" : k,'kNums':stock_num},
            dataType: "json",
            xhrFields: {withCredentials: true},
            success: function(model){
                //console.log(model);
                if(model.err_code==0){
                    //专卖商城
                    //console.log(resp);
                    if(model.data.status == 1){
                        var resp = model.data;
                        var res = resp.data;
                        var shoplist='';
                        $.each(resp.data, function(i){
                            var listblock = '<div class="list-block">';
                            listblock +='<div class="block-ul">'+search.block(resp.data,i)+'</div>';
                            // listblock +=search.morenumber();
                            if (res[i].data_list.length < res[i].total_num) {
                                var jian=res[i].total_num-res[i].data_list.length;
                                var more_number = '<div class="more-number">还有'
                                    +'<span class="f-blue">'+jian+'</span>'
                                    +'个商品未显示，<a href="javascript:void(0);" class="f-blue hhs_morenumber" onclick="" tatol_val="'+res[i].total_num+'" com_val="'+res[i].suplier_ids+'" flag_val="0">点击加载更多<i></i></a></div>';
                                listblock +=more_number+'</div>';
                            }else{
                                // var more_number2 = '<div class="more-number">为您找到'
                                //      +'<span class="f-blue">'+res[i].total_num+'</span>'
                                //      +'个商品，已全部显示</div>';
                                //  listblock +=more_number2+'</div>';
                            }

                            listblock +='</div>';
                            shoplist += listblock;
                        });
                        //shoplist += '<span id="hhs_all_com_ids" style="display:none">'+resp.all_com_ids+'</span>';
                        $('#shoplist').html(shoplist);
                        $('.wrap-search').append('<span id="hhs_all_com_ids" style="display:none">'+resp.all_com_ids+'</span>');

                        search.morenumber();
                        search.showCartMorePrice();
                        search.sumMoney();
                        radis_check();
                        //search.getGoodsName();

                        search.orderNum();
                    }else{
                        $('.TI_ONE').html('');
                        $('#shoplist').html('');
                        search.nocontent($('#shoplist'));
                    }
                    //走本地去联营数据
                    search.lianyin(model);
//                    $.each(model.data.temp_goods,function(i){
//                        alert(model.data.temp_goods.length);
//                    })
                    jjj(model.data.temp_goods,'fuck');
                    search.tiShow(model.data.ti);//ti推广
                }else{
                    suplier_num = suplier_num+2;
                    $('.TI_ONE').html('');
                    $('#shoplist').html('');
                    search.nocontent($('#shoplist'));
                }
            }
        });
    },
    lianyin:function(model){
        //走本地去联营数据
        suplier_num = suplier_num+1;
        if(model.data.lianyin_status == 1){
            flag = true;
            var resp = model.data;
            var res = resp.lianyin;
            var shoplist='';
            $.each(resp.lianyin, function(i){
                var listblock = '<div class="list-block">';
                listblock +='<div class="block-ul">'+search.block(resp.lianyin,i)+'</div>';
                // listblock +=search.morenumber();
                if (res[i].data_list.length < res[i].total_num) {
                    var jian=res[i].total_num-res[i].data_list.length;
                    var more_number = '<div class="more-number">还有'
                        +'<span class="f-blue">'+jian+'</span>'
                        +'个商品未显示，<a href="javascript:void(0);" class="f-blue hhs_morenumber" onclick="" tatol_val="'+res[i].total_num+'" com_val="'+res[i].suplier_ids+'" flag_val="1">点击加载更多<i></i></a></div>';
                    listblock +=more_number+'</div>';
                }else{
                    // var more_number2 = '<div class="more-number">为您找到'
                    //      +'<span class="f-blue">'+res[i].total_num+'</span>'
                    //      +'个商品，已全部显示</div>';
                    //  listblock +=more_number2+'</div>';
                }

                listblock +='</div>';
                shoplist += listblock;
            });
            //shoplist += '<span id="hhs_all_com_ids" style="display:none">'+resp.all_com_ids+'</span>';
            $('.lianyinlist').append(shoplist);
            $('.wrap-search').append('<span id="hhs_all_com_ids" style="display:none">'+resp.all_com_ids+'</span>');

            search.morenumber();
            search.showCartMorePrice();
            search.sumMoney();
            radis_check();
            //search.getGoodsName();

            search.orderNum();
        }else{
            //$('.TI_ONE').html('');
//                        $('#shoplist').html('');
//                        search.nocontent($('#shoplist'));
        }
        if(suplier_num == hhs_suplier_num && !flag){
            search.nocontent($('.lianyinlist'));
        }
    },
    //手动输入数量计算合计
    orderNum:function(){
        $('input[name="order_num"]').unbind('input propertychange');
        $('input[name="order_num"]').on('input propertychange',function(){
            search.inputMoney($(this),false);
        });
        $('input[name="order_num"]').unbind('change');
        $('input[name="order_num"]').on('change',function(){
            search.inputMoney($(this),true);
        });
        $('.hhs_bug').unbind('click');
        $('.hhs_bug').on('click',function(){
            search.userIsLogin($(this));
        });
        $('.hhs_cart').unbind('click');
        $('.hhs_cart').on('click',function(){
            search.joinCartOrBut($(this),'cart');
        });
        //去除颜色,如果没有加减，则去除价格样式
//        $.each('.hhs_goods',function(){
//            var flag = $(this).find('.hhs_cart').length;
//            if(flag == 0){
//                $(this).find('.act').removeClass('act');
//            }
//        });
    },
    //是否登录判断
    userIsLogin:function(obj){
        $.ajax({
            type: "POST",
            //url:URL_PRFIX+"api?mod=user&act=islogin",
            url:URL_api+"/login/check/?pf=1&callback=?",
            dataType: 'jsonp',
            xhrFields: {withCredentials: true},
            success: function(data){

                if(data.err_code==0){
                    var username=(data.data.user_name||data.data.mobile||data.data.email);
                    $(".loginx").hide();
                    $(".login-after").show();
                    $(".login-after .user-namex").text(username).attr("title",username);
                    $("#topNavLogin .login-name").hide();
                    $("#topNavLogin .nickname").show();
                    $("#topNavLogin #namex ").text(username);
                    $(".login-after .user-namex").text(username).attr("title",username)
                    $(".loginx").hide();
                    $(".login-after").show();
                    //详情页面
                    $(".hideLogin").hide();
                    if(obj){
                        search.joinCartOrBut(obj,'buy');
                    }
                }else{
                    if(obj){
                        $.popLogin({},function(){
                            search.joinCartOrBut(obj,'buy');
                            search.userIsLogin(flase);
                        });
                    }

                }
            }
        });
    },
    //加入购物车与立即购买
    //加入购物车与立即购买
    joinCartOrBut:function(obj,step){
        var tt = obj.parents('.hhs_goods');
        var currency = Number(tt.find('.act-radio').next().val());
        var goods_num = tt.find('input[name="order_num"]').val();
        var goods_id = parseInt(obj.attr('id_val'));
        var byt=obj.hasClass("hhs_cart")?-1:1;
        if(currency == 1){
            currency = 1;
        }else{
            currency = 2;
        }
        var data = {
            pf:1,
            id: goods_id,
            buy: byt,
            num: goods_num,
            delivery_place: currency
        }

        $.ajax({
            type: "POST",
            url: URL_api+"/cart/add ",
            data:data,
            dataType: dataTypeXpx,
            xhrFields: {withCredentials: true},
            success: function(data){
                if(data.err_code==0){
                    search.getCartNum();
                    //购买 或者添加
                    if(step=="buy"){
                        SetCookie("car_xk",data.data,365);
                        window.location.href=URL_PRFIX+"order/confirm";
                    }else{
                        $.popTip({text:'<i class="win-icon"></i>'+data.err_msg});
                    }
                }else{
                    $.popTip({text:'<i class="def-icon"></i>'+data.err_msg});
                }
            }
        });
    },
    //获取购物车数量
    getCartNum:function(){
        //购物车数量
        $.ajax({
            type: "POST",
            url: URL_api+"/cart/count",
            data:{pf:1},
            dataType: dataTypeXpx,
            xhrFields: {withCredentials: true},
            success: function(data){
                if(data.err_code==0){
                    $("#carNum").text(data.data)
                    $("#cartPat_side").text(data.data);
                }else{
                    $("#carNum").text(0);
                    $("#cartPat_side").text(0);
                }
            }

        })
    },
    //根据输入金额计算合计以及控制价格样式
    inputMoney:function(obj,flag){

        var tt = obj.parents('.hhs_goods');
        //alert(tt.find('.morePrice').html());
        var type = tt.children('.w-130').children('.time-cont').children('input[name="money_type"]').val();
        var jj = obj.parent().next().children('.addCart-currency');
        var rmb = eval('(' +obj.prev().attr('rmb_val')+ ')');
        var doll = eval('(' +obj.prev().attr('doll_val')+ ')');
        var nn = obj.val()>0 ? obj.val():0;
        var num = parseInt(nn);
        var cre = parseInt(obj.prev().attr('cre_val'));
        var start_val = parseInt(obj.prev().attr('start_val'));
        var stock_val = parseInt(obj.prev().attr('stock_val'));
        if(stock_val<num){
            num = stock_val;
            obj.val(num);
        }
        //如果为光标点击其他地方则触发倍数计算
        if(flag){
            if(num<start_val){
                num = start_val;
                search.tipShi(tt.find('.hhs_tishi1'),'',5000);
            }
            if(num>stock_val){
                num = stock_val;
                var msg = '请不要超过库存量：'+stock_val+' 若要采购更多，请联系在线客服';
                search.tipShi(tt.find('.hhs_tishi2'),'',5000);
            }else{
                var yu = num%cre;
                if(yu>0){
                    search.tipShi(tt.find('.hhs_tishi1'),'不支持拆包，请整包购买',5000);
                    num = num-yu+cre;
                }

            }
            obj.val(num);
        }
        var price = 0;
        var money = 0;
        var n = 0;
        if(type==1){
            $.each(rmb,function(i,item){
                if(num==i){
                    n = n + 1;
                    money = rmb[i]*num;
                    return false;
                }else if(num<i){
                    if(price==0){
                        price = rmb[i];
                    }
                    money = price*num;
                    return false;
                }
                n = n + 1;
                price = rmb[i];
            })
            if(money == 0){
                money = price*num;
            }
            var cont = '￥'+money.toFixed(4);
            jj.text(cont);
            //填充价格样式
            if(n>0){
                n = n-1;
            }
            //tt.find('.morePrice').children('div').eq(n-1).children('p').eq(1).children('span').removeClass('act');
            tt.find('.act').removeClass('act');
            tt.find('.morePrice').children('div').eq(n).children('p').eq(1).children('span').addClass('act');
        }else{
            $.each(doll,function(i){
                if(num==i){
                    n = n + 1;
                    money = doll[i]*num;
                    return false;
                }else if(num<i){
                    money = price*num;
                    return false;
                }
                n = n + 1;
                price = doll[i];
            })
            if(money == 0){
                money = price*num;
            }
            var cont = '$'+money.toFixed(4);
            jj.text(cont);
            //填充价格样式
            n = n-1;
            //tt.find('.morePrice').children('div').eq(n-1).children('p').eq(2).children('span').removeClass('act');
            tt.find('.act').removeClass('act');
            tt.find('.morePrice').children('div').eq(n).children('p').eq(2).children('span').addClass('act');
        }
        //展开价格
        if(n>=4 && tt.find('.icon-bot').text() != ''){
            tt.find('.more-height').trigger("click");
        }

    },
    //ti推广
    tiShow:function(res){
        if(res.length){
            var html  = '<div class="generalize hhs_generalize">';
            $.each(res,function(i){
                html += '<div class="block">'+
                '<em>推广</em>'+
                '<div class="ge_img"><img src="'+URL_DOMAIN+'/Uploads/suppliersImg/ti.jpg"></div>'+
                '<dl>'+
                '<dt>'+res[i].goods_name+'</dt>'+
                '<dd><p>'+res[i].goods_brief+'</p>';
                if(res[i].pdf_url != '' && res[i].pdf_url != null ){
                    html += '<p><img src="'+URL_DOMAIN+'/v3/dist/res/home/images/pdficon.png" alt="未加载" height="15" width="15"style="margin-right: 3px; vertical-align: middle;"><a href="'+res[i].pdf_url+'">数据手册</a></p>';
                }
                html += '</dd>'+
                '</dl>'+
                '<div class="text">'+
                '<p>库存：'+(res[i].goods_number>0 ? res[i].goods_number:'--')+'</p>'+
                '<p>价格：$'+res[i].price+'</p>'+
                '</div>'+
                '<div class="anniu">'+
                '<a href="'+res[i].detailUrl+'" class="gray" target="_blank">查看详情</a>';
                if(res[i].goods_number>0){
                    html += '<a href="'+res[i].buyUrl+'" class="red" target="_blank">立即购买</a>';
                }
                html += '</div></div>';
            })
            html += '<div class="number hhs_ti_show"><a href="javascript:void(0);">展开<span>∨</span></a></div></div>';
            $.each($('.TI_ONE'),function(){
                $(this).html(html);
            })
            $.each($('.hhs_generalize'),function(i){
                //$(this).find('.block').eq(0).show().siblings('.block').hide();
                var moreLink=$(this).children(".block");
                var moreMax=$(this).children(".hhs_ti_show");
                if(moreLink.length > 1){
                    moreLink.eq(0).show().siblings('.block').hide();
                    $(moreMax).toggle(function(){
                        $(this).siblings('.block').slideDown("slow");
                        $(this).html('<a href="javascript:void(0);">收起<span>∧</span></a>')
                    },function(){
                        $(this).siblings(".block:gt(0)").slideUp("hide");
                        $(this).html('<a href="javascript:void(0);">展开<span>∨</span></a>')
                    });
                }else{
                    $(moreMax).hide();
                }
            })

        }else{
            $('.TI_ONE').html('');
        }
    },
    //获取所有专卖的商品名作为下拉列表
    getGoodsName:function(){
        var com_ids = $('#hhs_all_com_ids').text();
        k = $('.hhs_input_k').val();
        stock_num = $('.hhs_input_num').val();
        $.ajax({
            type: "POST",
            url: URL_PRFIX+"api?mod=Search&act=GetName",
            data:{"all_com_ids" : com_ids, "kNums" : stock_num,"k" : k},
            dataType: "json",
            xhrFields: {withCredentials: true},
            success: function(model){
                //console.log(model);
                if(model.err_code==0){
                    var html = '';
                    $.each(model.data,function(i){
                        html += '<li>'+model.data[i].goods_name+'</li>';
                    })
                    //把数据放进下拉表
                    $.each($('.selectbox-cont'),function(i){
                        $(this).append(html);
                        //渲染点击事件
                        findGoods();
                    });

                }else{

                }
            }
        });
    },
    //搜索数据UL
    block:function(res,i){
//        var resp = model.data;
//        var res = resp.data;
        var listblock='';
        for(var j=0;j<res[i].data_list.length;j++){
            var datalist=res[i].data_list[j];
            var html='<ul class="clear hhs_goods">';
            var html1='<li class="w-110"><p><a href="'+URL_DOMAIN+'/goods_'+datalist['goods_id']+'.html'+'" target="_blank" class="fw">'+datalist['goods_name_temp']+'</a></p></li>';
            if(res[i].temp_com_id && stra_msg[res[i].temp_com_id]){
                var html_hint='<div class="hint"><div class="arrow"><span></span><i></i></div><p>'+datalist['strategy_info']+'</p></div></div>';
            }else{
                var html_hint='</div>';
            }
            html2='<li class="w-130"><div class="name-text">'+datalist['com_name']+html_hint+'</li>',
                html3='<li class="w-160">'+datalist['brand_name']+'</li>',
                html4='<li class="w-90">'
                +'<p><span class="f-gray">批次：</span>'+(datalist['product_batch']?datalist['product_batch']:'--')+'</p>'
                +'<p><span class="f-gray">编号：</span>'+datalist['sale_no']+'</p>'
                +'</li>',
                html5='<li class="w-90">'
                +'<p><span class="f-gray">库存：</span><span class="f-red">'+datalist['goods_number']+'</span></p>'
                +'<p><span class="f-gray">起订：</span>'+datalist['moq']+'</p>'
                +'<p><span class="f-gray" title="标准包装量">MPQ：</span>'+datalist['mpq']+'</p>'
                +'</li>';
            var html6='<li class="w-260 morePrice">';
            var htmlsix='<div class="more-height"><span class="icon-bot">更多梯度价格<i></i></span></div></li>'
            var morePrice = '';
            var price_dollor = '{';
            var price_rmb = '{';
            var priceone = '';
            var price_temp = 0;
            var price_one;
            var last_price = 0;
            var rmb_flag = true;
            var len = datalist.msg_price.length;
            var stock_temp = datalist['moq'];
            stock_num = parseInt(stock_num);
            var yu = stock_num%(datalist['mpq']);
            var hhs_start_stype = 0;//用于初始样式展示
            var hhs_last_num = 0;//用于初始样式展示
            //如果用户有输入库存作为搜索条件，则合计与初始数量以库存量为准
            if(yu===0 && stock_num>datalist['moq']){
                datalist['moq'] = stock_num;
            }
            if(len>0){
                for(var tt=0;tt<len;tt++){
                    datalist.msg_price[tt]['goods_num'] = parseInt(datalist.msg_price[tt]['goods_num']);
                    datalist['moq'] = parseInt(datalist['moq']);
                    if(datalist.msg_price[tt]['goods_num'] == datalist['moq']){
                        hhs_start_stype = datalist.msg_price[tt]['goods_num'];
                        if(datalist.msg_price[tt]['rmb_price']>0){
                            price_temp = datalist.msg_price[tt]['rmb_price'];break;
                        }else{
                            price_temp = datalist.msg_price[tt]['dollor_price'];break;
                        }
                    }else if(datalist.msg_price[tt]['goods_num'] > datalist['moq']){
                        hhs_start_stype = hhs_last_num;
                        price_temp = last_price;break;
                    }
                    hhs_last_num = datalist.msg_price[tt]['goods_num'];
                    if(datalist.msg_price[tt]['rmb_price']>0){
                        last_price = datalist.msg_price[tt]['rmb_price'];
                    }else{
                        last_price = datalist.msg_price[tt]['dollor_price'];
                    }
                }
                if(price_temp == 0){
                    if(last_price>0){
                        price_temp = last_price;
                        hhs_start_stype = hhs_last_num;
                    }else{
                        hhs_start_stype = datalist.msg_price[0]['goods_num'];
                        if(datalist.msg_price[0]['rmb_price']>0){
                            price_temp = datalist.msg_price[0]['rmb_price'];
                        }else{
                            price_temp = datalist.msg_price[0]['dollor_price'];
                        }
                    }

                }
                for (var e=0;e<len;e++) {
                    var msgprice=datalist.msg_price[e];
                    morePrice +='<div class="list_data">'
                    +'<p class="w-20"><span>'+msgprice['goods_num']+'</span></p>';
                    if ((parseInt(datalist['goods_number'])<parseInt(datalist['moq']))) {
                        morePrice += '<p class="w-40"><span class="'+(hhs_start_stype==msgprice['goods_num'] ? '':'')+'">'+(msgprice['rmb_price']>0 ? '￥'+msgprice['rmb_price'] : '--')+'</span></p>';
                        morePrice += '<p class="w-40"><span>'+(msgprice['dollor_price']>0 ? '$'+msgprice['dollor_price'] : '--')+'</span></p>';
                        price_one = price_temp*datalist['moq'];
                        priceone = '￥'+price_one.toFixed(4);
                    }else{
                        if(datalist.msg_price[0]['dollor_price']<=0 && datalist.msg_price[0]['rmb_price']>0){
                            morePrice += '<p class="w-40"><span class="'+(hhs_start_stype==msgprice['goods_num'] ? 'act':'')+'">'+(msgprice['rmb_price']>0 ? '￥'+msgprice['rmb_price'] : '--')+'</span></p>';
                            morePrice += '<p class="w-40"><span>'+(msgprice['dollor_price']>0 ? '$'+msgprice['dollor_price'] : '--')+'</span></p>';
                            price_one = price_temp*datalist['moq'];
                            priceone = '￥'+price_one.toFixed(4);
                        }else if(datalist.msg_price[0]['rmb_price']<=0 && datalist.msg_price[0]['goods_num']>0){
                            morePrice += '<p class="w-40"><span>'+(msgprice['rmb_price']>0 ? '￥'+msgprice['rmb_price'] : '--')+'</span></p>';
                            morePrice += '<p class="w-40"><span class="'+(hhs_start_stype==msgprice['dollor_price'] ? 'act':'')+'">'+(msgprice['dollor_price']>0 ? '$'+msgprice['dollor_price'] : '--')+'</span></p>';
                            price_one = price_temp*datalist['moq'];
                            priceone = '$'+price_one.toFixed(4);
                            rmb_flag = false;
                        }else{
                            morePrice += '<p class="w-40"><span class="'+((hhs_start_stype==msgprice['goods_num']&&price_temp>0) ? 'act':'')+'">'+(msgprice['rmb_price']>0 ? '￥'+msgprice['rmb_price'] : '--')+'</span></p>';
                            morePrice += '<p class="w-40"><span>'+(msgprice['dollor_price']>0 ? '$'+msgprice['dollor_price'] : '--')+'</span></p>';
                            price_one = price_temp*datalist['moq'];
                            priceone = '￥'+price_one.toFixed(4);
                        }
                    }


                    morePrice += '</div>';
                    price_rmb += (msgprice['goods_num']+':"'+msgprice['rmb_price']+'",');
                    price_dollor += (msgprice['goods_num']+':"'+msgprice['dollor_price']+'",');
                }
            }else{
                morePrice +='<div class="list_data">'
                +'<p class="w-20"><span>--</span></p>';
                morePrice += '<p class="w-40"><span class="">--</span></p>';
                morePrice += '<p class="w-40"><span>--</span></p>';
                morePrice += '</div>';
            }
            var priceobj = '';
            var pricermb = '';
            if(len>0){
                var nn = price_dollor.length-1;
                var mm = price_rmb.length-1;
                priceobj = (price_dollor.substr(0,nn))+'}';
                pricermb = (price_rmb.substr(0,mm))+'}';
            }
            var temp_order_num;
            if(yu==0){
                temp_order_num = datalist['moq'];
                datalist['moq'] = stock_temp;
            }else{
                temp_order_num = stock_temp;
            }
            var labelone='<p><label><span class="check-img"><i class="icon-check '+(rmb_flag ? '':'act-radio')+'"></i>'
                +'<input type="radio" start_num_val="'+(datalist['moq']?datalist['moq']:1)+'" name="currency'+datalist['goods_id']+'" value="0"></span>香港：'+datalist['delivery_time']+'</label></p>';
            var labeltwo='<p><label><span class="check-img"><i class="icon-check '+(rmb_flag ? 'act-radio':'')+'"></i>'
                +'<input type="radio" start_num_val="'+(datalist['moq']?datalist['moq']:1)+'" name="currency'+datalist['goods_id']+'" value="1" checked></span>国内：'+datalist['delivery_time']+'</label></p>';
            var edit_inpu ='<div class="edit-input clear">'
                +'<div class="warn-hint ta-c hhs_tishi1"><i class="arrow"></i><i class="icon-warn"></i><p>购买数量不能少于起订量！</p></div>'
                +'<div class="warn-hint hhs_tishi2"><i class="arrow"></i><i class="icon-warn fl-l"></i><p class="fl-l">购买数量不能超过库存量，若要采购更多，请联系在线客服！</p></div>'
                +'<span class="reduce" stock_val="'+(datalist['goods_number']?datalist['goods_number']:'--')+'" start_val="'+(datalist['moq']?datalist['moq']:1)+'" cre_val='+datalist['mpq']+' doll_val='+priceobj+' rmb_val='+pricermb+'>-</span>'
                +'<input type="" name="order_num" value="'+temp_order_num+'">'
                +'<span class="increase" stock_val="'+(datalist['goods_number']?datalist['goods_number']:'--')+'" start_val="'+(datalist['moq']?datalist['moq']:1)+'" cre_val='+datalist['mpq']+' rmb_val='+pricermb+' doll_val='+priceobj+'>+</span>'
                +'</div>'
                +'<p class="f-red addCart-total">合计：'+'<b class="addCart-currency">'+priceone+'</b></p>';
            var but='<a href="javascript:void(0)" id_val="'+datalist['goods_id']+'" name_val="'+datalist['goods_name']+'" source_val="0" class="but popup-but hhs_cart">加入购物车</a>';
            var but2='<a href="http://wpa.b.qq.com/cgi/wpa.php?ln=2&uin=800158432&o=www.ichunt.com&q=7&ref=http://www.ichunt.com/" target="_blank" class="but but-orange">立即询价</a>';
            var editcont=''
            var labelcont='';
            var enddiv = '';
            if ((datalist.msg_price.length==0) || (parseInt(datalist['goods_number'])<parseInt(datalist['moq'])) || (parseInt(datalist['goods_number'])<parseInt(datalist['mpq'])) || (datalist.msg_price[0]['rmb_price']<=0 && datalist.msg_price[0]['dollor_price']<=0)) {
                labelcont+='--';
                enddiv = '</div>';
                editcont+=but2;
                //morePrice+= '--';
            }else if(datalist.msg_price[0]['dollor_price']<=0 && datalist.msg_price[0]['rmb_price']>0){
                labelcont+=labeltwo;
                editcont+=edit_inpu+but;
                enddiv = '</div><a href="javascript:void(0)" id_val="'+datalist['goods_id']+'" name_val="'+datalist['goods_name']+'" source_val="0" class="but but-white hhs_bug">立即购买</a>';
            }else if(datalist.msg_price[0]['rmb_price']<=0 && datalist.msg_price[0]['dollor_price']>0){
                labelcont+=labelone;
                editcont+=edit_inpu+but;
                enddiv = '</div><a href="javascript:void(0)" id_val="'+datalist['goods_id']+'" name_val="'+datalist['goods_name']+'" source_val="0" class="but but-white hhs_bug">立即购买</a>';
            }else{
                labelcont+=labelone+labeltwo;
                enddiv = '</div><a href="javascript:void(0)" id_val="'+datalist['goods_id']+'" name_val="'+datalist['goods_name']+'" source_val="0" class="but but-white hhs_bug">立即购买</a>';
                editcont+=edit_inpu+but;
            }
            labelcont += enddiv;
            var html7='<li class="w-130"><div class="time-cont"><input type="hidden" name="money_type" value="'+(rmb_flag ? 1:0)+'"/>'+labelcont+'</li>';
            var html8='<li class="w-126 edit-but">'+editcont+'</li>';
            var htmlend='</ul>';
            listblock += html+html1+html2+html3+html4+html5+html6+morePrice+htmlsix+html7+html8+htmlend;
        }
        return listblock;
    },
    //更多阶梯价格
    showCartMorePrice: function() {
        for(var m=0;m< $(".morePrice").length;m++) {
            var moreLink=$(".morePrice").eq(m).children(".list_data");
            var moreMax=$(".morePrice").eq(m).children(".more-height");
            if(moreLink.length > 4){
                $(moreMax).show();
                var flag = false;
                $.each($(".morePrice").eq(m).find('.list_data'),function(i){
                    if($(this).find('.act').length==1 && i>3){
                        flag = true;return false;
                    }
                })
                if(flag){
                    $(".morePrice").eq(m).children(".list_data").show();
                    $(".morePrice").eq(m).find('.more-height').html('<span class="icon-top">收起梯度价格<i></i></span>');
                    $(moreMax).toggle(function(){
                        $(this).siblings(".list_data:gt(3)").slideUp("hide");
                        $(this).html('<span class="icon-bot">更多梯度价格<i></i></span>');
                    },function(){
                        $(this).siblings().slideDown("slow");
                        $(this).html('<span class="icon-top">收起梯度价格<i></i></span>');
                    });
                }else{
                    $(".morePrice").eq(m).children(".list_data").slice(0,4).show();
                    $(moreMax).toggle(function(){
                        $(this).siblings().slideDown("slow");
                        $(this).html('<span class="icon-top">收起梯度价格<i></i></span>');
                    },function(){
                        $(this).siblings(".list_data:gt(3)").slideUp("hide");
                        $(this).html('<span class="icon-bot">更多梯度价格<i></i></span>');
                    });
                }

            }else{
                $(moreLink).show()
                $(moreMax).hide();
            }
        }
    },
    tipShi:function(obj,text,t){
        if(text != ''){
            obj.children('p').text(text);
        }
        obj.show();
        setTimeout(function(){
            $(obj).fadeOut(300);
        },t);
    },
    //数字加减
    sumMoney: function(){
        $('.increase').unbind('click');
        $('.increase').on('click',function(){
            var tt = $(this).parents('.hhs_goods');
            //alert(tt.find('.morePrice').html());
            var type = tt.children('.w-130').children('.time-cont').children('input[name="money_type"]').val();
            var jj = $(this).parent().next().children('.addCart-currency');
            var rmb = eval('(' +$(this).attr('rmb_val')+ ')');
            var doll = eval('(' +$(this).attr('doll_val')+ ')');
            var num = $(this).prev().val();
            var cre = parseInt($(this).attr('cre_val'));
            var start_val = parseInt($(this).attr('start_val'));
            var stock_val = parseInt($(this).attr('stock_val'));
            num = parseInt(num) + cre;
            if(stock_val<num){
                num = stock_val;
                var msg = '请不要超过库存量：'+stock_val+' 若要采购更多，请联系在线客服';
                search.tipShi(tt.find('.hhs_tishi2'),'',3000);
            }
            var price=0;
            var money = 0;
            $(this).prev().val(num);
            var n = 0;
            if(type==1){
                $.each(rmb,function(i,item){
                    if(num==i){
                        n = n + 1;
                        money = rmb[i]*num;
                        return false;
                    }else if(num<i){
                        if(price==0){
                            price = doll[i];
                        }
                        money = price*num;
                        return false;
                    }
                    n = n + 1;
                    price = rmb[i];
                })
                if(money == 0){
                    money = price*num;
                }
                var cont = '￥'+money.toFixed(4);
                jj.text(cont);
                //填充价格样式
                if(n!=0){
                    n = n-1;
                }
                tt.find('.act').removeClass('act');
                tt.find('.morePrice').children('div').eq(n).children('p').eq(1).children('span').addClass('act');
            }else{
                $.each(doll,function(i){
                    if(num==i){
                        n = n + 1;
                        money = doll[i]*num;
                        return false;
                    }else if(num<i){
                        if(price==0){
                            price = doll[i];
                        }
                        money = price*num;
                        return false;
                    }
                    n = n + 1;
                    price = doll[i];
                })
                if(money == 0){
                    money = price*num;
                }
                var cont = '$'+money.toFixed(4);
                jj.text(cont);
                //填充价格样式
                if(n!=0){
                    n = n-1;
                }
                tt.find('.act').removeClass('act');
                tt.find('.morePrice').children('div').eq(n).children('p').eq(2).children('span').addClass('act');
            }
            //展开价格
            if(n>=4 && tt.find('.icon-bot').text() != ''){
                tt.find('.more-height').trigger("click");
            }
        })
        $('.reduce').unbind('click');
        $('.reduce').on('click',function(){
            var tt = $(this).parents('.hhs_goods');
            var type = tt.children('.w-130').children('.time-cont').children('input[name="money_type"]').val();
            var jj = $(this).parent().next().children('.addCart-currency');
            var rmb = eval('(' +$(this).attr('rmb_val')+ ')');
            var doll = eval('(' +$(this).attr('doll_val')+ ')');
            var num = $(this).next().val();
            var cre = parseInt($(this).attr('cre_val'));
            var start_val = parseInt($(this).attr('start_val'));
            num = parseInt(num) - cre;
            if(num<start_val){
                search.tipShi(tt.find('.hhs_tishi1'),'',3000);
                num = start_val;
            }
            $(this).next().val(num);
            var price=0;
            var money = 0;
            var n = 0;
            if(type==1){
                $.each(rmb,function(i){
                    if(num==i){
                        n = n + 1;
                        money = rmb[i]*num;
                        return false;
                    }else if(num<i){
                        if(price==0){
                            price = doll[i];
                        }
                        money = price*num;
                        return false;
                    }
                    n = n + 1;
                    price = rmb[i];
                })
                if(money == 0){
                    money = price*num;
                }
                var cont = '￥'+money.toFixed(4);
                jj.text(cont);
                //填充价格样式
                if(n!=0){
                    n = n-1;
                }
                
                tt.find('.act').removeClass('act');
                tt.find('.morePrice').children('div').eq(n).children('p').eq(1).children('span').addClass('act');
            }else{
                $.each(doll,function(i){
                    if(num==i){
                        n = n + 1;
                        money = doll[i]*num;
                        return false;
                    }else if(num<i){
                        if(price==0){
                            price = doll[i];
                        }
                        money = price*num;
                        return false;
                    }
                    n = n + 1;
                    price = doll[i];
                })
                if(money == 0){
                    money = price*num;
                }
                var cont = '$'+money.toFixed(4);
                jj.text(cont);
                //填充价格样式
                if(n!=0){
                    n = n-1;
                }
                tt.find('.act').removeClass('act');
                tt.find('.morePrice').children('div').eq(n).children('p').eq(2).children('span').addClass('act');
            }
        })
    },
    //加载更多
    morenumber:function(){
        $('.hhs_morenumber').unbind('click');
        $('.hhs_morenumber').on('click',function(){
            var ids = $(this).attr('com_val');
            var flag = $(this).attr('flag_val');
            var current = $(this);
            var jian = parseInt(current.parents('.more-number').children('span').text());
            var tatol = parseInt(current.attr('tatol_val'));
            var p = Math.ceil((tatol-jian)/pagesize) + 1;
            jian = jian-pagesize;
            k = $('.hhs_input_k').val();
            stock_num = $('.hhs_input_num').val();
            $.isLoding();
            $('.loding').css({'top':'200px','left':'45%','background':'#535353','filter':'alpha(Opacity=80)','-moz-opacity':0.5,'opacity':0.5});
            $.ajax({
                type: "POST",
                url: URL_PRFIX+"api?mod=Search&act=SearchLoadMore",
                data:{"com_ids" : ids, "kNums" : stock_num,"k" : k, "p":p,'flag':flag },
                dataType: "json",
                success: function(model){
                    lodingHide();
                    if(model.err_code==0){
                        var resp = model.data;
                        var res = resp.data;
                        $.each(res, function(i){
                            var listblock='';
                            listblock += search.block(resp.data,i);
                            //console.log(listblock);
                            //$(this).parents(".more-number").prev('.block-ul').append(listblock);
                            current.parents(".more-number").prev('.block-ul').append(listblock);
                            if(jian>0){
                                current.parents('.more-number').children('span').text(jian)
                            }else{
                                current.parents('.more-number').html('为您找到<span class="f-blue">'+tatol+'</span>个商品，已全部显示');
                            }
                            search.showCartMorePrice();
                            search.sumMoney();
                            radis_check();
                            search.orderNum();//计算直接数入数量
                            search.morenumber();
                        });
                    }else{

                    }
                }
            })
        });
    },
    //没有内容
    nocontent:function(obj){
        no_num = no_num+1;
        var no_content='<dl class="no_content">'
            +'<dt><i class="icon-mark-o"></i></dt>'
            +'<dd>'
            +'<h2>很抱歉！暂时没有找到您要找的型号</h2>'
            +'<p><a href="http://wpa.b.qq.com/cgi/wpa.php?ln=2&uin=800158432&o=www.ichunt.com&q=7&ref=http://www.ichunt.com/" target="_blank" class="but">去人工找货</a></p>'
            +'</dd>'
            +'</dl>';
        //$('.search-product .block .list').append(no_content);
        obj.html(no_content);
        obj.parent().hide();
        if(no_num==3){
            $('.search-yes').html(no_content);
        }
    }
};
